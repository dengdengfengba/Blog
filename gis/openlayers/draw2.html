<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>draw原理 | 等等风吧</title>
    <meta name="description" content="等等风的个人博客">
    <link rel="apple-touch-icon" href="/Blog/apple-touch-icon.png">
  <link rel="icon" href="/Blog/favicon-32x32.png">
  <link rel="manifest" href="/Blog/manifest.json">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/Blog/assets/css/0.styles.f4f6d0f1.css" as="style"><link rel="preload" href="/Blog/assets/js/app.0ad31845.js" as="script"><link rel="preload" href="/Blog/assets/js/2.1b5dd912.js" as="script"><link rel="preload" href="/Blog/assets/js/16.458a1e33.js" as="script"><link rel="preload" href="/Blog/assets/js/4.a1875dba.js" as="script"><link rel="prefetch" href="/Blog/assets/js/10.136c3538.js"><link rel="prefetch" href="/Blog/assets/js/11.12bceb81.js"><link rel="prefetch" href="/Blog/assets/js/12.c0e97e00.js"><link rel="prefetch" href="/Blog/assets/js/13.98392899.js"><link rel="prefetch" href="/Blog/assets/js/14.1a016337.js"><link rel="prefetch" href="/Blog/assets/js/15.8552bcca.js"><link rel="prefetch" href="/Blog/assets/js/17.67ad1ebe.js"><link rel="prefetch" href="/Blog/assets/js/18.e3a80131.js"><link rel="prefetch" href="/Blog/assets/js/19.7e8621a9.js"><link rel="prefetch" href="/Blog/assets/js/20.cd4ef131.js"><link rel="prefetch" href="/Blog/assets/js/21.d0904527.js"><link rel="prefetch" href="/Blog/assets/js/22.49895c6b.js"><link rel="prefetch" href="/Blog/assets/js/23.86d794cd.js"><link rel="prefetch" href="/Blog/assets/js/24.e31324ae.js"><link rel="prefetch" href="/Blog/assets/js/25.b8433c7d.js"><link rel="prefetch" href="/Blog/assets/js/26.6b1a1ab1.js"><link rel="prefetch" href="/Blog/assets/js/27.9381e493.js"><link rel="prefetch" href="/Blog/assets/js/28.7d39c37b.js"><link rel="prefetch" href="/Blog/assets/js/29.866cb72b.js"><link rel="prefetch" href="/Blog/assets/js/3.aba7f2b2.js"><link rel="prefetch" href="/Blog/assets/js/30.0aa32a81.js"><link rel="prefetch" href="/Blog/assets/js/31.44290afc.js"><link rel="prefetch" href="/Blog/assets/js/32.3cf2a1f9.js"><link rel="prefetch" href="/Blog/assets/js/33.71d68c25.js"><link rel="prefetch" href="/Blog/assets/js/34.5c6eedf2.js"><link rel="prefetch" href="/Blog/assets/js/35.8e4b784e.js"><link rel="prefetch" href="/Blog/assets/js/36.3da44658.js"><link rel="prefetch" href="/Blog/assets/js/37.4accd394.js"><link rel="prefetch" href="/Blog/assets/js/38.aa2bb673.js"><link rel="prefetch" href="/Blog/assets/js/39.4c249910.js"><link rel="prefetch" href="/Blog/assets/js/40.90359bf7.js"><link rel="prefetch" href="/Blog/assets/js/41.ddce87f5.js"><link rel="prefetch" href="/Blog/assets/js/42.7e8c7a2d.js"><link rel="prefetch" href="/Blog/assets/js/43.ef98017e.js"><link rel="prefetch" href="/Blog/assets/js/44.aa779bb0.js"><link rel="prefetch" href="/Blog/assets/js/5.c75dcd3b.js"><link rel="prefetch" href="/Blog/assets/js/6.7e1b8072.js"><link rel="prefetch" href="/Blog/assets/js/7.35f20a04.js"><link rel="prefetch" href="/Blog/assets/js/8.fa8588d8.js"><link rel="prefetch" href="/Blog/assets/js/9.dff8b2a7.js">
    <link rel="stylesheet" href="/Blog/assets/css/0.styles.f4f6d0f1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Blog/" class="home-link router-link-active"><!----> <span class="site-name">等等风吧</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Blog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/web/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/Blog/web/javascript/" class="nav-link">javascript</a></li></ul></div></div><div class="nav-item"><a href="/Blog/backend/" class="nav-link">后端</a></div><div class="nav-item"><a href="/Blog/sql/" class="nav-link">数据库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Gis</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/gis/OGC/" class="nav-link">OGC</a></li><li class="dropdown-item"><!----> <a href="/Blog/gis/openlayers/" class="nav-link router-link-active">openlayers</a></li></ul></div></div><div class="nav-item"><a href="/Blog/about/" class="nav-link">大杂烩</a></div><div class="nav-item"><a href="/Blog/wen/" class="nav-link">好文欣赏</a></div><div class="nav-item"><a href="/Blog/guide/" class="nav-link">Guide</a></div> <a href="https://github.com/dengdengfengba/Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Blog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/web/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/Blog/web/javascript/" class="nav-link">javascript</a></li></ul></div></div><div class="nav-item"><a href="/Blog/backend/" class="nav-link">后端</a></div><div class="nav-item"><a href="/Blog/sql/" class="nav-link">数据库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Gis</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/gis/OGC/" class="nav-link">OGC</a></li><li class="dropdown-item"><!----> <a href="/Blog/gis/openlayers/" class="nav-link router-link-active">openlayers</a></li></ul></div></div><div class="nav-item"><a href="/Blog/about/" class="nav-link">大杂烩</a></div><div class="nav-item"><a href="/Blog/wen/" class="nav-link">好文欣赏</a></div><div class="nav-item"><a href="/Blog/guide/" class="nav-link">Guide</a></div> <a href="https://github.com/dengdengfengba/Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>openlayers</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Blog/gis/openlayers/" class="sidebar-link">首页</a></li><li><a href="/Blog/gis/openlayers/map.html" class="sidebar-link">创建一个地图实例</a></li><li><a href="/Blog/gis/openlayers/view.html" class="sidebar-link">地图视图</a></li><li><a href="/Blog/gis/openlayers/layers.html" class="sidebar-link">地图图层</a></li><li><a href="/Blog/gis/openlayers/vector.html" class="sidebar-link">地图矢量图层</a></li><li><a href="/Blog/gis/openlayers/source.html" class="sidebar-link">地图图层数据来源</a></li><li><a href="/Blog/gis/openlayers/style.html" class="sidebar-link">地图样式</a></li><li><a href="/Blog/gis/openlayers/control.html" class="sidebar-link">地图控件</a></li><li><a href="/Blog/gis/openlayers/interaction.html" class="sidebar-link">地图交互</a></li><li><a href="/Blog/gis/openlayers/draw1.html" class="sidebar-link">draw详解</a></li><li><a href="/Blog/gis/openlayers/draw2.html" class="active sidebar-link">draw原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/draw2.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/draw2.html#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/draw2.html#实现细节" class="sidebar-link">实现细节</a></li><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/draw2.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/draw2.html#相关链接" class="sidebar-link">相关链接</a></li></ul></li><li><a href="/Blog/gis/openlayers/overlay.html" class="sidebar-link">地图覆盖物</a></li><li><a href="/Blog/gis/openlayers/popup.html" class="sidebar-link">地图弹出框</a></li><li><a href="/Blog/gis/openlayers/control1.html" class="sidebar-link">地图自定义控件</a></li><li><a href="/Blog/gis/openlayers/event.html" class="sidebar-link">地图事件</a></li><li><a href="/Blog/gis/openlayers/event1.html" class="sidebar-link">地图鼠标右键事件</a></li><li><a href="/Blog/gis/openlayers/point1.html" class="sidebar-link">地图点聚集</a></li><li><a href="/Blog/gis/openlayers/point2.html" class="sidebar-link">动态点扩散效果</a></li><li><a href="/Blog/gis/openlayers/point3.html" class="sidebar-link">地图实时追踪轨迹</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <p>在 ol 中，负责交互的模块中，有一个负责绘制图形的交互模块，这个交互子模块是 <code>ol.interaction.Draw</code>。该模块允许用户通过鼠标点击（PC浏览器环境）或者手指触摸（ 触屏手机浏览器环境）在地图上绘制点、线 和 面。</p> <p>注：绘制完成之前的要素图形我们称之为草图（sketch），绘制完成的图形称为要素（feature）。</p> <h2 id="实现原理"><a href="#实现原理" aria-hidden="true" class="header-anchor">#</a> 实现原理</h2> <p>绘制交互是通过鼠标或手指的点击添加点的坐标的，OpenLayers 会自动将 屏幕坐标转换为 地图坐标，点击绘制完成后，所有的点初始化一个 geometry 对象，然后利用这个 geometry 初始化一个 feature。在上一篇介绍绘制用法时，我们知道初始化一个绘制交互，要传一个 features 参数或者 source 参数，如果是 features，那么勾绘完成的 feature 就会添加到 features 集合中，而 features 会属于一个 source，而 source 又属于 layer，layer 属于一个 map，这样，勾绘的要素（feature）就会显示到地图中。这个过程比较麻烦，估计会绕晕，我们用一张图进行说明：</p> <p><img src="https://img-blog.csdn.net/20150924130819954" alt="markdown" title="markdown"></p> <p>该类中，有几个私有变量，维护着绘制过程中的坐标和子要素或者绘制状态等内容，主要有以下几个：</p> <ul><li>finishCoordinate_，绘制的要素的完成点坐标，对于多边形来说是第一个点，因为多边形要闭合，所以第一个点和最后一个点是重合的。而对于多边形来说，最后一个点就是最后一个点</li> <li>sketchFeature_，草图的要素</li> <li>sketchPoint_，草图的点要素</li> <li>sketchCoords_，草图的点要素的坐标集合，用于绘制要素为线或多边形时</li> <li>sketchLine_，草图的线要素，用于绘制要素为多边形时</li> <li>sketchLineCoords_，草图的线坐标，当绘制多边形或圆形时用到</li></ul> <h2 id="实现细节"><a href="#实现细节" aria-hidden="true" class="header-anchor">#</a> 实现细节</h2> <ol><li>私有的辅助函数</li></ol> <p>ol.interaction.Draw 类中，私有的辅助函数包括：</p> <ul><li>ol.interaction.Draw.handleDownEvent_，处理鼠标按下的事件</li> <li>ol.interaction.Draw.handleUpEvent_，处理松开鼠标单击的事件</li> <li>ol.interaction.Draw.getMode_，获得绘制要素的 geometry 类型，包含四种：Point、LineString、Circle和Polygon</li> <li>ol.interaction.Draw.prototype.handlePointerMove_，处理鼠标移动事件</li> <li>ol.interaction.Draw.prototype.atFinish_，判断一个事件是否在捕捉勾绘开始坐标的容差之内</li> <li>ol.interaction.Draw.prototype.createOrUpdateSketchPoint_，创建或者更新一个点要素的坐标</li> <li>ol.interaction.Draw.prototype.startDrawing_，获取事件对象的点坐标，根据设置的绘制类型，初始化一些维护坐标数据的私有变量,同时触发 drawstart 事件</li> <li>ol.interaction.Draw.prototype.modifyDrawing_，获取事件的点坐标，利用该坐标，根据绘制要素类型，修改相应要素的第一个坐标（多边形）最后一个（线或圆）坐标</li> <li>ol.interaction.Draw.prototype.addToDrawing_，获取事件对象包含的点坐标，并添加到当前绘制的要素</li> <li>ol.interaction.Draw.prototype.abortDrawing_， 停止绘制，并返回 sketchFeature_</li> <li>ol.interaction.Draw.prototype.updateSketchFeatures_，根据不同的情况，将 sketchFeature_ 、sketchLine_ 或 sketchPoint_ 对象 push 到 sketchFeatures 中，然后 在矢量图层中移除所有要素，并重新添加 sketchFeatures 中保存的所有要素，这个函数就像 Windows 系统下的桌面刷新功能差不多</li></ul> <p>实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Redraw the sketch features.
 * @private
 */</span>
ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span><span class="token class-name">Draw</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">updateSketchFeatures_</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> sketchFeatures <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sketchFeature_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sketchFeatures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sketchFeature_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sketchLine_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sketchFeatures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sketchLine_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sketchPoint_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sketchFeatures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sketchPoint_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> overlaySource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>overlay_<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  overlaySource<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  overlaySource<span class="token punctuation">.</span><span class="token function">addFeatures</span><span class="token punctuation">(</span>sketchFeatures<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>ol.interaction.Draw.prototype.updateState_，这个辅助函数主要是获取 draw 交互的状态，是 active 还是 deactive，具体实现如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @private
 */</span>
ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span><span class="token class-name">Draw</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">updateState_</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> active <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map <span class="token operator">||</span> <span class="token operator">!</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">abortDrawing_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>overlay_<span class="token punctuation">.</span><span class="token function">setMap</span><span class="token punctuation">(</span>active <span class="token operator">?</span> map <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>纵观所有这些辅助的私有函数，基本的思路就是根据发生的事件，获取事件对象，获取对象包含的坐标，根据具体情况对以上提到的保存数据的六个私有变量进行修改，来达到目的。</p> <ol start="2"><li>公有 API 函数</li></ol> <p>对外的 API 函数有以下几个，这些对外的公有函数，也无外乎使用辅助的私有函数或者私有变量来完成一些具体的操作。如下所示：</p> <ul><li>ol.interaction.Draw.handleEvent，处理 ol.MapBrowserEvent，返回一个布尔值，表明是否应该继续或者结束绘制。其定义如下：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token comment">/**
* Handles the {@link ol.MapBrowserEvent map browser event} and may actually
* draw or finish the drawing.
* @param {ol.MapBrowserEvent} mapBrowserEvent Map browser event.
* @return {boolean} `false` to stop event propagation.
* @this {ol.interaction.Draw}
* @api
*/</span>
   ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>Draw<span class="token punctuation">.</span><span class="token function-variable function">handleEvent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">mapBrowserEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> pass <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>freehand_<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>freehand_ <span class="token operator">&amp;&amp;</span>
       mapBrowserEvent<span class="token punctuation">.</span>type <span class="token operator">===</span> ol<span class="token punctuation">.</span>MapBrowserEvent<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span><span class="token constant">POINTERDRAG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addToDrawing_</span><span class="token punctuation">(</span>mapBrowserEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
       pass <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mapBrowserEvent<span class="token punctuation">.</span>type <span class="token operator">===</span>
       ol<span class="token punctuation">.</span>MapBrowserEvent<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span><span class="token constant">POINTERMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       pass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handlePointerMove_</span><span class="token punctuation">(</span>mapBrowserEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mapBrowserEvent<span class="token punctuation">.</span>type <span class="token operator">===</span> ol<span class="token punctuation">.</span>MapBrowserEvent<span class="token punctuation">.</span>EventType<span class="token punctuation">.</span><span class="token constant">DBLCLICK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       pass <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>Pointer<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mapBrowserEvent<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pass<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>this.freehand_</code>默认是 false，这里将 pass 赋值为 true。首先检查是否设置了 <code>freehand_</code>模式，且检查发生的事件是否是鼠标拖拽事件，如果同时满足两个条件，就将事件对象中包含的坐标添加到当前正在绘制的多边形（因为只有多边形才有 freehand_ 模式），同时将 pass 设置为 false；如果不满足第一个条件，那么检查传来的事件是否是鼠标移动事件，如果是，调用的函数始终返回 true，但是会判断用户是否已经点击了最后一个点（<code>finishCoordinate_</code>），如果点击了，就将事件对象传递给 modifyDrawing_，如果没有定义，那么就将事件对象传递给 <code>createOrUpdateSketchPoint_</code> ；如果前面两个条件都不满足，那么检查事件是否是鼠标双击事件，那么就将 pass 赋值为 false。</p> <ul><li>ol.interaction.Draw.createRegularPolygon，该函数返回一个基于 <code>Circle</code> 绘制类型的 <code>geometryFunction</code> 函数（这种函数返回一个 <code>geometry</code> 对象），接受两个参数，分别是 边的数量（<code>opt_sides</code>）和 多边形的角度（<code>opt_angle</code>）。其定义如下：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Create a `geometryFunction` for `mode: 'Circle'` that will create a regular
 * polygon with a user specified number of sides and start angle instead of an
 * `ol.geom.Circle` geometry.
 * @param {number=} opt_sides Number of sides of the regular polygon. Default is
 *     32.
 * @param {number=} opt_angle Angle of the first point in radians. 0 means East.
 *     Default is the angle defined by the heading from the center of the
 *     regular polygon to the current pointer position.
 * @return {ol.interaction.DrawGeometryFunctionType} Function that draws a
 *     polygon.
 * @api
 */</span>
ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>Draw<span class="token punctuation">.</span><span class="token function-variable function">createRegularPolygon</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">opt_sides<span class="token punctuation">,</span> opt_angle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token comment">/**
       * @param {ol.Coordinate|Array.&lt;ol.Coordinate&gt;|Array.&lt;Array.&lt;ol.Coordinate&gt;&gt;} coordinates
       * @param {ol.geom.SimpleGeometry=} opt_geometry
       * @return {ol.geom.SimpleGeometry}
       */</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">coordinates<span class="token punctuation">,</span> opt_geometry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> center <span class="token operator">=</span> coordinates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> end <span class="token operator">=</span> coordinates<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> radius <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>
            ol<span class="token punctuation">.</span>coordinate<span class="token punctuation">.</span><span class="token function">squaredDistance</span><span class="token punctuation">(</span>center<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> geometry <span class="token operator">=</span> opt_geometry <span class="token operator">?</span> opt_geometry <span class="token punctuation">:</span>
            ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>Polygon<span class="token punctuation">.</span><span class="token function">fromCircle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>Circle</span><span class="token punctuation">(</span>center<span class="token punctuation">)</span><span class="token punctuation">,</span> opt_sides<span class="token punctuation">)</span><span class="token punctuation">;</span>
        goog<span class="token punctuation">.</span>asserts<span class="token punctuation">.</span><span class="token function">assertInstanceof</span><span class="token punctuation">(</span>geometry<span class="token punctuation">,</span> ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>Polygon<span class="token punctuation">,</span>
            <span class="token string">'geometry must be a polygon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> angle <span class="token operator">=</span> opt_angle <span class="token operator">?</span> opt_angle <span class="token punctuation">:</span>
            Math<span class="token punctuation">.</span><span class="token function">atan</span><span class="token punctuation">(</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> center<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> center<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>Polygon<span class="token punctuation">.</span><span class="token function">makeRegular</span><span class="token punctuation">(</span>geometry<span class="token punctuation">,</span> center<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> geometry<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>从上面的定义可以看出，该函数返回的 <code>geometry</code>是由两个点坐标构成的，分别是 center 和 end，之所以将end 赋值为 <code>coordinate[1]</code>，是因为这是基于使用 <code>Circle</code> 模式为前提的，在这种模式下，只需要单击两次鼠标就可以完成绘制，所以 <code>coordinate</code> 数组中只有两个坐标，由于是 <code>circle</code> 模式，其半径是两点之间的距离；返回的函数中的第二个参数是 绘制的类型，必须是多边形；角度如果没有指定的话，那么就将两个坐标点的连线与水平（也就是东西走向）所成的角度。最后，将这些所需的参数都确定之后，利用这些参数调用了 <code>ol.geom.polygon.makeRegular</code> 函数，这个函数的主要作用是将 <code>polygon</code> 类型修改为一个规则多边形。</p> <p>举例说明:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> vector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>Vector</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   source<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>source<span class="token punctuation">.</span>Vector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    target<span class="token punctuation">:</span> <span class="token string">'map'</span><span class="token punctuation">,</span>
    layers<span class="token punctuation">:</span> <span class="token punctuation">[</span> vector <span class="token punctuation">]</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>View</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        center<span class="token punctuation">:</span> ol<span class="token punctuation">.</span>proj<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">120.896637</span><span class="token punctuation">,</span><span class="token number">31.381207</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'EPSG:4326'</span><span class="token punctuation">,</span> <span class="token string">'EPSG:3857'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        zoom<span class="token punctuation">:</span> <span class="token number">15</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后初始化一个 <code>draw interaction</code>，将其绘制模式设置为 <code>Circle</code>，<code>source</code> 设置为矢量图层的 <code>source（vector.getSource( )）</code>，<code>geometryFunction</code> 设置为我们这里介绍的函数创建（<code>ol.interaction.Draw.createRegularPolygon(3)</code>），并将其加入到地图中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> draw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>Draw</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'Circle'</span><span class="token punctuation">,</span>
    source<span class="token punctuation">:</span> vector<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    geometryFunction<span class="token punctuation">:</span> ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>Draw<span class="token punctuation">.</span><span class="token function">createRegularPolygon</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

map<span class="token punctuation">.</span><span class="token function">addInteraction</span><span class="token punctuation">(</span>draw<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>效果展示：</p> <p><img src="https://img-blog.csdn.net/20150929231314459" alt="markdown" title="markdown"></p> <p>这里我们创建的是三条边的规则多边形（ol.interaction.Draw.createRegularPolygon(3)），自然就是三角形，我们将边数 3 换为 4 或者 5，效果如下：</p> <p><img src="https://img-blog.csdn.net/20150929231655950" alt="markdown" title="markdown"></p> <p><img src="https://img-blog.csdn.net/20150929231917497" alt="markdown" title="markdown"></p> <p>如果继续增大边数，绘制的形状会越来越接近圆形。</p> <ul><li>ol.interaction.Draw.prototype.removeLastPoint，该函数作用是删除正处于绘制的线或者多边形的最后一个点。该函数只作用于正在绘制，且并未完成的要素。其实现源码如下：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Remove last point of the feature currently being drawn.
 * @api
 */</span>
ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span><span class="token class-name">Draw</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">removeLastPoint</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> geometry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sketchFeature_<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  goog<span class="token punctuation">.</span>asserts<span class="token punctuation">.</span><span class="token function">assertInstanceof</span><span class="token punctuation">(</span>geometry<span class="token punctuation">,</span> ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>SimpleGeometry<span class="token punctuation">,</span>
      <span class="token string">'geometry must be an ol.geom.SimpleGeometry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> coordinates<span class="token punctuation">,</span> sketchLineGeom<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mode_ <span class="token operator">===</span> ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>DrawMode<span class="token punctuation">.</span><span class="token constant">LINE_STRING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    coordinates <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sketchCoords_<span class="token punctuation">;</span>
    coordinates<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">geometryFunction_</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">,</span> geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mode_ <span class="token operator">===</span> ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>DrawMode<span class="token punctuation">.</span><span class="token constant">POLYGON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    coordinates <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sketchCoords_<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    coordinates<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sketchLineGeom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sketchLine_<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    goog<span class="token punctuation">.</span>asserts<span class="token punctuation">.</span><span class="token function">assertInstanceof</span><span class="token punctuation">(</span>sketchLineGeom<span class="token punctuation">,</span> ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>LineString<span class="token punctuation">,</span>
        <span class="token string">'sketchLineGeom must be an ol.geom.LineString'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sketchLineGeom<span class="token punctuation">.</span><span class="token function">setCoordinates</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">geometryFunction_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sketchCoords_<span class="token punctuation">,</span> geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>coordinates<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>finishCoordinate_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateSketchFeatures_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>在管理绘制的这个类中，<code>sketchFeature_</code> 是该类的私有变量，保存的是正在绘制的要素（<code>feature</code>）。该函数首先获取当前要素的 <code>geometry</code> 子对象，然后获取当前绘制的坐标数组，删除数组中的倒数第二个点（因为倒数第一个点还没有点定，是当前悬挂的点），然后重新构造 <code>geometry</code> 返回给当前绘制的要素（<code>feature</code>），并更新当前绘制的要素。</p> <p>举例说明：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> draw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>Draw</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'Polygon'</span><span class="token punctuation">,</span>
    source<span class="token punctuation">:</span> vector<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//geometryFunction: ol.interaction.Draw.createRegularPolygon(5)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后在地图上添加一个按钮，用来触发该函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#undo'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    draw<span class="token punctuation">.</span><span class="token function">removeLastPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>效果展示：</p> <p><img src="https://img-blog.csdn.net/20150930100531085" alt="markdown" title="markdown"></p> <p>然后我们绘制一个多边形，然后点击按钮，取消绘制的前一个点，效果如下：</p> <p><img src="https://img-blog.csdn.net/20150930100751591" alt="markdown" title="markdown"></p> <p>该函数可以用作 回退（undo） 操作。</p> <ul><li>ol.interaction.Draw.prototype.finishDrawing，该函数用于停止绘制，并将当前勾绘的要素添加到目标图层，在这里是我们上面的例子中的 vector。该函数在将要素添加到目标图层之前，会触发 drawend 事件。其具体实现如下：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
* Stop drawing and add the sketch feature to the target layer.
* The {@link ol.interaction.DrawEventType.DRAWEND} event is dispatched before
* inserting the feature.
* @api
*/</span>
ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span><span class="token class-name">Draw</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finishDrawing</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">var</span> sketchFeature <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">abortDrawing_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 goog<span class="token punctuation">.</span>asserts<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>goog<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>sketchFeature<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token string">'sketchFeature should not be null'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> coordinates <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sketchCoords_<span class="token punctuation">;</span>
 <span class="token keyword">var</span> geometry <span class="token operator">=</span> sketchFeature<span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 goog<span class="token punctuation">.</span>asserts<span class="token punctuation">.</span><span class="token function">assertInstanceof</span><span class="token punctuation">(</span>geometry<span class="token punctuation">,</span> ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>SimpleGeometry<span class="token punctuation">,</span>
     <span class="token string">'geometry must be an ol.geom.SimpleGeometry'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mode_ <span class="token operator">===</span> ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>DrawMode<span class="token punctuation">.</span><span class="token constant">LINE_STRING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// remove the redundant last point</span>
   coordinates<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">geometryFunction_</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">,</span> geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mode_ <span class="token operator">===</span> ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>DrawMode<span class="token punctuation">.</span><span class="token constant">POLYGON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// When we finish drawing a polygon on the last point,</span>
   <span class="token comment">// the last coordinate is duplicated as for LineString</span>
   <span class="token comment">// we force the replacement by the first point</span>
   coordinates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   coordinates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">geometryFunction_</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">,</span> geometry<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// cast multi-part geometries</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type_ <span class="token operator">===</span> ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>GeometryType<span class="token punctuation">.</span><span class="token constant">MULTI_POINT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   sketchFeature<span class="token punctuation">.</span><span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>MultiPoint</span><span class="token punctuation">(</span><span class="token punctuation">[</span>coordinates<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type_ <span class="token operator">===</span> ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>GeometryType<span class="token punctuation">.</span><span class="token constant">MULTI_LINE_STRING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   sketchFeature<span class="token punctuation">.</span><span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>MultiLineString</span><span class="token punctuation">(</span><span class="token punctuation">[</span>coordinates<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type_ <span class="token operator">===</span> ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>GeometryType<span class="token punctuation">.</span><span class="token constant">MULTI_POLYGON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   sketchFeature<span class="token punctuation">.</span><span class="token function">setGeometry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>geom<span class="token punctuation">.</span>MultiPolygon</span><span class="token punctuation">(</span><span class="token punctuation">[</span>coordinates<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// First dispatch event to allow full set up of feature</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>DrawEvent</span><span class="token punctuation">(</span>
     ol<span class="token punctuation">.</span>interaction<span class="token punctuation">.</span>DrawEventType<span class="token punctuation">.</span><span class="token constant">DRAWEND</span><span class="token punctuation">,</span> sketchFeature<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Then insert feature</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>goog<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>features_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>features_<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sketchFeature<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>goog<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>source_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>source_<span class="token punctuation">.</span><span class="token function">addFeature</span><span class="token punctuation">(</span>sketchFeature<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>该函数和上面的函数类似，首先获得当前绘制的要素（<code>var sketchFeature = this.abortDrawing_()</code>;）、<code>geometry</code>对象和坐标，然后删除最后一个悬挂的点，重新返回新的 <code>geometry</code>，并传给 <code>feature</code>，以完成绘制。同样，我们举例说明，这个例子和上面的例子几乎一模一样，所以不再详述实现，对勾图标对应调用该函数。实现效果如下：</p> <p><img src="https://img-blog.csdn.net/20150930113059012" alt="markdown" title="markdown"></p> <ul><li>ol.interaction.Draw.prototype.extend，该函数将参数所指的要素进行继续编辑绘制，主要用途是对已经绘制好的要素进行再附加点，只对 LineString 类型有效。实现过程就是首先获取参数要素的坐标数组，然后将该坐标数组 push 到当前绘制的数组进行继续绘制。实现方式和前面的函数非常相似，这里不再详述，想详细了解可以看看其 GitHub 的代码。</li></ul> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>不仅仅是这个类，还包括其他的类都是这个思路，总体分为三层：私有变量、私有辅助函数和对外的 API 函数，其功能如下图：</p> <p><img src="https://img-blog.csdn.net/20151002115052460" alt="markdown" title="markdown"></p> <p>不仅仅是 ol 的设计，其他库的设计也大致是这样；不仅仅是 JavaScript ，很多其他的语言的类设计也是这样。其实这就是面向对象的思想的体现 - 封装。</p> <h2 id="相关链接"><a href="#相关链接" aria-hidden="true" class="header-anchor">#</a> 相关链接</h2> <p><a href="https://blog.csdn.net/qingyafan/article/details/48489033" target="_blank" rel="noopener noreferrer">CSDN庆祝亚运会<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dengdengfengba/Blog/edit/master/docs/gis/openlayers/draw2.md" target="_blank" rel="noopener noreferrer">编辑该文档</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2019-10-6 17:16:27</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Blog/gis/openlayers/draw1.html" class="prev">draw详解</a></span> <span class="next"><a href="/Blog/gis/openlayers/overlay.html">地图覆盖物</a>→
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/Blog/assets/js/app.0ad31845.js" defer></script><script src="/Blog/assets/js/2.1b5dd912.js" defer></script><script src="/Blog/assets/js/16.458a1e33.js" defer></script><script src="/Blog/assets/js/4.a1875dba.js" defer></script>
  </body>
</html>
