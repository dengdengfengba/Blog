<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>地图点聚集 | 等等风吧</title>
    <meta name="description" content="等等风的个人博客">
    <link rel="apple-touch-icon" href="/Blog/apple-touch-icon.png">
  <link rel="icon" href="/Blog/favicon-32x32.png">
  <link rel="manifest" href="/Blog/manifest.json">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/Blog/assets/css/0.styles.f4f6d0f1.css" as="style"><link rel="preload" href="/Blog/assets/js/app.0ad31845.js" as="script"><link rel="preload" href="/Blog/assets/js/2.1b5dd912.js" as="script"><link rel="preload" href="/Blog/assets/js/23.86d794cd.js" as="script"><link rel="preload" href="/Blog/assets/js/4.a1875dba.js" as="script"><link rel="prefetch" href="/Blog/assets/js/10.136c3538.js"><link rel="prefetch" href="/Blog/assets/js/11.12bceb81.js"><link rel="prefetch" href="/Blog/assets/js/12.c0e97e00.js"><link rel="prefetch" href="/Blog/assets/js/13.98392899.js"><link rel="prefetch" href="/Blog/assets/js/14.1a016337.js"><link rel="prefetch" href="/Blog/assets/js/15.8552bcca.js"><link rel="prefetch" href="/Blog/assets/js/16.458a1e33.js"><link rel="prefetch" href="/Blog/assets/js/17.67ad1ebe.js"><link rel="prefetch" href="/Blog/assets/js/18.e3a80131.js"><link rel="prefetch" href="/Blog/assets/js/19.7e8621a9.js"><link rel="prefetch" href="/Blog/assets/js/20.cd4ef131.js"><link rel="prefetch" href="/Blog/assets/js/21.d0904527.js"><link rel="prefetch" href="/Blog/assets/js/22.49895c6b.js"><link rel="prefetch" href="/Blog/assets/js/24.e31324ae.js"><link rel="prefetch" href="/Blog/assets/js/25.b8433c7d.js"><link rel="prefetch" href="/Blog/assets/js/26.6b1a1ab1.js"><link rel="prefetch" href="/Blog/assets/js/27.9381e493.js"><link rel="prefetch" href="/Blog/assets/js/28.7d39c37b.js"><link rel="prefetch" href="/Blog/assets/js/29.866cb72b.js"><link rel="prefetch" href="/Blog/assets/js/3.aba7f2b2.js"><link rel="prefetch" href="/Blog/assets/js/30.0aa32a81.js"><link rel="prefetch" href="/Blog/assets/js/31.44290afc.js"><link rel="prefetch" href="/Blog/assets/js/32.3cf2a1f9.js"><link rel="prefetch" href="/Blog/assets/js/33.71d68c25.js"><link rel="prefetch" href="/Blog/assets/js/34.5c6eedf2.js"><link rel="prefetch" href="/Blog/assets/js/35.8e4b784e.js"><link rel="prefetch" href="/Blog/assets/js/36.3da44658.js"><link rel="prefetch" href="/Blog/assets/js/37.4accd394.js"><link rel="prefetch" href="/Blog/assets/js/38.aa2bb673.js"><link rel="prefetch" href="/Blog/assets/js/39.4c249910.js"><link rel="prefetch" href="/Blog/assets/js/40.90359bf7.js"><link rel="prefetch" href="/Blog/assets/js/41.ddce87f5.js"><link rel="prefetch" href="/Blog/assets/js/42.7e8c7a2d.js"><link rel="prefetch" href="/Blog/assets/js/43.ef98017e.js"><link rel="prefetch" href="/Blog/assets/js/44.aa779bb0.js"><link rel="prefetch" href="/Blog/assets/js/5.c75dcd3b.js"><link rel="prefetch" href="/Blog/assets/js/6.7e1b8072.js"><link rel="prefetch" href="/Blog/assets/js/7.35f20a04.js"><link rel="prefetch" href="/Blog/assets/js/8.fa8588d8.js"><link rel="prefetch" href="/Blog/assets/js/9.dff8b2a7.js">
    <link rel="stylesheet" href="/Blog/assets/css/0.styles.f4f6d0f1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Blog/" class="home-link router-link-active"><!----> <span class="site-name">等等风吧</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Blog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/web/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/Blog/web/javascript/" class="nav-link">javascript</a></li></ul></div></div><div class="nav-item"><a href="/Blog/backend/" class="nav-link">后端</a></div><div class="nav-item"><a href="/Blog/sql/" class="nav-link">数据库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Gis</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/gis/OGC/" class="nav-link">OGC</a></li><li class="dropdown-item"><!----> <a href="/Blog/gis/openlayers/" class="nav-link router-link-active">openlayers</a></li></ul></div></div><div class="nav-item"><a href="/Blog/about/" class="nav-link">大杂烩</a></div><div class="nav-item"><a href="/Blog/wen/" class="nav-link">好文欣赏</a></div><div class="nav-item"><a href="/Blog/guide/" class="nav-link">Guide</a></div> <a href="https://github.com/dengdengfengba/Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Blog/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/web/css/" class="nav-link">css</a></li><li class="dropdown-item"><!----> <a href="/Blog/web/javascript/" class="nav-link">javascript</a></li></ul></div></div><div class="nav-item"><a href="/Blog/backend/" class="nav-link">后端</a></div><div class="nav-item"><a href="/Blog/sql/" class="nav-link">数据库</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Gis</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/gis/OGC/" class="nav-link">OGC</a></li><li class="dropdown-item"><!----> <a href="/Blog/gis/openlayers/" class="nav-link router-link-active">openlayers</a></li></ul></div></div><div class="nav-item"><a href="/Blog/about/" class="nav-link">大杂烩</a></div><div class="nav-item"><a href="/Blog/wen/" class="nav-link">好文欣赏</a></div><div class="nav-item"><a href="/Blog/guide/" class="nav-link">Guide</a></div> <a href="https://github.com/dengdengfengba/Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>openlayers</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Blog/gis/openlayers/" class="sidebar-link">首页</a></li><li><a href="/Blog/gis/openlayers/map.html" class="sidebar-link">创建一个地图实例</a></li><li><a href="/Blog/gis/openlayers/view.html" class="sidebar-link">地图视图</a></li><li><a href="/Blog/gis/openlayers/layers.html" class="sidebar-link">地图图层</a></li><li><a href="/Blog/gis/openlayers/vector.html" class="sidebar-link">地图矢量图层</a></li><li><a href="/Blog/gis/openlayers/source.html" class="sidebar-link">地图图层数据来源</a></li><li><a href="/Blog/gis/openlayers/style.html" class="sidebar-link">地图样式</a></li><li><a href="/Blog/gis/openlayers/control.html" class="sidebar-link">地图控件</a></li><li><a href="/Blog/gis/openlayers/interaction.html" class="sidebar-link">地图交互</a></li><li><a href="/Blog/gis/openlayers/draw1.html" class="sidebar-link">draw详解</a></li><li><a href="/Blog/gis/openlayers/draw2.html" class="sidebar-link">draw原理</a></li><li><a href="/Blog/gis/openlayers/overlay.html" class="sidebar-link">地图覆盖物</a></li><li><a href="/Blog/gis/openlayers/popup.html" class="sidebar-link">地图弹出框</a></li><li><a href="/Blog/gis/openlayers/control1.html" class="sidebar-link">地图自定义控件</a></li><li><a href="/Blog/gis/openlayers/event.html" class="sidebar-link">地图事件</a></li><li><a href="/Blog/gis/openlayers/event1.html" class="sidebar-link">地图鼠标右键事件</a></li><li><a href="/Blog/gis/openlayers/point1.html" class="active sidebar-link">地图点聚集</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/point1.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/point1.html#具体实现" class="sidebar-link">具体实现</a></li><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/point1.html#cluster原理" class="sidebar-link">Cluster原理</a></li><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/point1.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/Blog/gis/openlayers/point1.html#相关链接" class="sidebar-link">相关链接</a></li></ul></li><li><a href="/Blog/gis/openlayers/point2.html" class="sidebar-link">动态点扩散效果</a></li><li><a href="/Blog/gis/openlayers/point3.html" class="sidebar-link">地图实时追踪轨迹</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <p>点聚集指在某个缩放级别下，将临近（一般用像素距离衡量）的点聚合为一个点要素显示，这在房屋中介的等的地图找房功能中很常见，如下图。但是这样的例子并不恰当，地图找房里的聚集确切的说并不是点聚集，他们是在每一级别显示某一级区块，然后在区块多边形的质心或者什么地方设置一个点要素，用预先统计好的数量给这个点要素设置样式而已。</p> <p><img src="https://img-blog.csdn.net/20180915120540899?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Fpbmd5YWZhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="markdown" title="markdown"></p> <p>而我们要做的是动态聚类，在每一个地图缩放级别，动态扫描每个要素周围的要素，生成聚集的点要素。这里，我们利用USGS的地震数据，结合openlayers尝试实现全球地震点聚集可视化的功能。最终结果如图：</p> <p><img src="https://img-blog.csdn.net/2018091512062022?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Fpbmd5YWZhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="markdown" title="markdown"></p> <h2 id="具体实现"><a href="#具体实现" aria-hidden="true" class="header-anchor">#</a> 具体实现</h2> <p>openlayers 提供了一个点聚集图层数据源类型ol.source.Cluster，结合矢量图层即可构造一个简单的聚集图层。点聚集图层数据源的distance类型控制聚集的阈值，当两点间像素距离小于20时便聚集为一个点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 聚类图层</span>
earthquakeCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>Vector</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    source<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>source<span class="token punctuation">.</span>Cluster</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        distance<span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>
        source<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>source<span class="token punctuation">.</span>Vector</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            format<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>format<span class="token punctuation">.</span>GeoJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            url<span class="token punctuation">:</span> <span class="token string">'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用 styleFunction 修改默认样式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 样式函数，对每个feature返回一个样式</span>
<span class="token keyword">let</span> currentResolution<span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">styleFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">feature<span class="token punctuation">,</span> resolution</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolution <span class="token operator">!=</span> currentResolution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">calculateClusterInfo</span><span class="token punctuation">(</span>resolution<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/** key code 2 **/</span>
        currentResolution <span class="token operator">=</span> resolution<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> style<span class="token punctuation">;</span>
    <span class="token keyword">let</span> size <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'features'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        style <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            image<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Circle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                radius<span class="token punctuation">:</span> feature<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'radius'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/** key code 1 **/</span>
                fill<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            text<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Text</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                text<span class="token punctuation">:</span> size<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                fill<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    color<span class="token punctuation">:</span> <span class="token string">'#fff'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                stroke<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Stroke</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    color<span class="token punctuation">:</span> <span class="token string">'rgba(0, 0, 0, 0.6)'</span><span class="token punctuation">,</span>
                    width<span class="token punctuation">:</span> <span class="token number">3</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 每个地震点的默认样式</span>
        style <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            image<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Circle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                radius<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                fill<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    color<span class="token punctuation">:</span> <span class="token string">'rgb(255, 0, 0)'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> style<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>把改样式设置给图层即可。如果聚集包含的点数量多于1个，设置聚集的样式，如果是1个，应用普通的点样式。重点关注标记了 <strong>key code 1</strong> 的那一行，我们对点要素使用了circle样式，并使用要素的radius属性值作为其半径，radius属性并不是聚集点要素的自带属性，我们要预先计算好。（注意： 这里我们使用了半径区别聚集，我们可以使用其他样式，比如颜色的深浅等指标）那么便需要关注 <strong>key code 2</strong>，<code>calculateClusterInfo(resolution)</code>便初始化了每个聚集的radius属性：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 初始化聚集要素的半径</span>
<span class="token comment">// 可自由定义要素半径的计算规则</span>
<span class="token keyword">let</span> maxFeatureCount<span class="token punctuation">;</span>
<span class="token keyword">let</span> earthquakeCluster <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">calculateClusterInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resolution</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    maxFeatureCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> features <span class="token operator">=</span> earthquakeCluster<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> feature<span class="token punctuation">,</span> radius<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> features<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        feature <span class="token operator">=</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> originalFeatures <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'features'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> extent <span class="token operator">=</span> ol<span class="token punctuation">.</span>extent<span class="token punctuation">.</span><span class="token function">createEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> jj <span class="token operator">=</span> originalFeatures<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">&lt;</span>jj<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ol<span class="token punctuation">.</span>extent<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> originalFeatures<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        maxFeatureCount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxFeatureCount<span class="token punctuation">,</span> jj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        radius <span class="token operator">=</span> <span class="token number">0.15</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ol<span class="token punctuation">.</span>extent<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span> <span class="token operator">+</span> ol<span class="token punctuation">.</span>extent<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> resolution<span class="token punctuation">;</span> <span class="token comment">/** key code **/</span>
        feature<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'radius'</span><span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上代码使用每个聚集包含的所有点要素的范围和地图的分辨率计算了radius，并不是包含的点要素的数量作为半径，所以你会发现并不是数量越多聚集的半径越大，而是聚集包含的点要素的范围越大，聚集半径越大，（注意这里你可以使用其他的指标计算半径，比如聚集包含的点的数量）。</p> <p>完整代码：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>地震点聚集<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./css/ol.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./js/ol.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>map<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token comment">// 初始化聚集要素的半径</span>
        <span class="token comment">// 可自由定义要素半径的计算规则</span>
        <span class="token keyword">let</span> maxFeatureCount<span class="token punctuation">;</span>
        <span class="token keyword">let</span> earthquakeCluster <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token function-variable function">calculateClusterInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">resolution</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            maxFeatureCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> features <span class="token operator">=</span> earthquakeCluster<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> feature<span class="token punctuation">,</span> radius<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> features<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                feature <span class="token operator">=</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> originalFeatures <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'features'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> extent <span class="token operator">=</span> ol<span class="token punctuation">.</span>extent<span class="token punctuation">.</span><span class="token function">createEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> jj <span class="token operator">=</span> originalFeatures<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">&lt;</span>jj<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ol<span class="token punctuation">.</span>extent<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> originalFeatures<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getGeometry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                maxFeatureCount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxFeatureCount<span class="token punctuation">,</span> jj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                radius <span class="token operator">=</span> <span class="token number">0.15</span> <span class="token operator">*</span> <span class="token punctuation">(</span>ol<span class="token punctuation">.</span>extent<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span> <span class="token operator">+</span> ol<span class="token punctuation">.</span>extent<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> resolution<span class="token punctuation">;</span>
                feature<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'radius'</span><span class="token punctuation">,</span> radius<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 样式函数，对每个feature返回一个样式</span>
        <span class="token keyword">let</span> currentResolution<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token function-variable function">styleFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">feature<span class="token punctuation">,</span> resolution</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolution <span class="token operator">!=</span> currentResolution<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">calculateClusterInfo</span><span class="token punctuation">(</span>resolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
                currentResolution <span class="token operator">=</span> resolution<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">let</span> style<span class="token punctuation">;</span>
            <span class="token keyword">let</span> size <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'features'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                style <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    image<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Circle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        radius<span class="token punctuation">:</span> feature<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'radius'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        fill<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            color<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    text<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Text</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        text<span class="token punctuation">:</span> size<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        fill<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            color<span class="token punctuation">:</span> <span class="token string">'#fff'</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        stroke<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Stroke</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            color<span class="token punctuation">:</span> <span class="token string">'rgba(0, 0, 0, 0.6)'</span><span class="token punctuation">,</span>
                            width<span class="token punctuation">:</span> <span class="token number">3</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 每个地震点的默认样式</span>
                style <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    image<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Circle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        radius<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
                        fill<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>style<span class="token punctuation">.</span>Fill</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            color<span class="token punctuation">:</span> <span class="token string">'rgb(255, 0, 0)'</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> style<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 聚类图层</span>
        earthquakeCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>Vector</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            source<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>source<span class="token punctuation">.</span>Cluster</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                distance<span class="token punctuation">:</span> <span class="token number">80</span><span class="token punctuation">,</span>   <span class="token comment">// 聚类阈值，当两点间距离小于20，便聚类为一个点</span>
                source<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>source<span class="token punctuation">.</span>Vector</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    format<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>format<span class="token punctuation">.</span>GeoJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    url<span class="token punctuation">:</span> <span class="token string">'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            style<span class="token punctuation">:</span> styleFunction
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>Map</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            target<span class="token punctuation">:</span> <span class="token string">'map'</span><span class="token punctuation">,</span>
            layers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>layer<span class="token punctuation">.</span>Tile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    source<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>source<span class="token punctuation">.</span>OSM</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            view<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ol<span class="token punctuation">.</span>View</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                center<span class="token punctuation">:</span> ol<span class="token punctuation">.</span>proj<span class="token punctuation">.</span><span class="token function">fromLonLat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">118</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                zoom<span class="token punctuation">:</span> <span class="token number">2</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">addLayer</span><span class="token punctuation">(</span>earthquakeCluster<span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="cluster原理"><a href="#cluster原理" aria-hidden="true" class="header-anchor">#</a> Cluster原理</h2> <p>ol具体实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolution <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>features<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> extent <span class="token operator">=</span> <span class="token function">createEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mapDistance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>distance <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolution<span class="token punctuation">;</span>
<span class="token keyword">const</span> features <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">getFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> clustered <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ii <span class="token operator">=</span> features<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> feature <span class="token operator">=</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">getUid</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> clustered<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> geometry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">geometryFunction</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>geometry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> coordinates <span class="token operator">=</span> geometry<span class="token punctuation">.</span><span class="token function">getCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">createOrUpdateFromCoordinate</span><span class="token punctuation">(</span>coordinates<span class="token punctuation">,</span> extent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">buffer</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> mapDistance<span class="token punctuation">,</span> extent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> neighbors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">getFeaturesInExtent</span><span class="token punctuation">(</span>extent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        neighbors <span class="token operator">=</span> neighbors<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">neighbor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> uid <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span>neighbor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>uid <span class="token keyword">in</span> clustered<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            clustered<span class="token punctuation">[</span>uid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>features<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createCluster</span><span class="token punctuation">(</span>neighbors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>遍历所有的点要素（可以是其它类型的要素：线、面，但要为每个要素定义<code>geometryFunction</code>，接受每个要素的geometry，返回点geometry，所以我们可以取面的质心或者取线的中点等），首先，对要素做缓冲区<code>buffer(extent, mapDistance, extent)</code>;，缓冲区的半径是根据传入的距离阈值和分辨率计算得到<code>const mapDistance = this.distance * this.resolution</code>;，然后，在这个缓冲区中寻找不在其他聚集中(<code>clustered</code>)的点要素，最后，将聚集的位置设置在包含点的中心：<code>this.features.push(this.createCluster(neighbors))</code>;，<code>this.createCluster(neighbors)</code>计算这些点的中心。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>点聚集可以看很多呈点状分布的现象，如分析垃圾堆放点、村落分布、地震分布等，通过聚集我们可以看出它们的分布特点，当然我们也可以对面或线状要素做同样的聚集，但是效果应该不会很好。</p> <h2 id="相关链接"><a href="#相关链接" aria-hidden="true" class="header-anchor">#</a> 相关链接</h2> <p><a href="https://blog.csdn.net/qingyafan/article/details/82712666" target="_blank" rel="noopener noreferrer">CSDN庆祝亚运会<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dengdengfengba/Blog/edit/master/docs/gis/openlayers/point1.md" target="_blank" rel="noopener noreferrer">编辑该文档</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2019-10-6 17:16:27</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Blog/gis/openlayers/event1.html" class="prev">地图鼠标右键事件</a></span> <span class="next"><a href="/Blog/gis/openlayers/point2.html">动态点扩散效果</a>→
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/Blog/assets/js/app.0ad31845.js" defer></script><script src="/Blog/assets/js/2.1b5dd912.js" defer></script><script src="/Blog/assets/js/23.86d794cd.js" defer></script><script src="/Blog/assets/js/4.a1875dba.js" defer></script>
  </body>
</html>
